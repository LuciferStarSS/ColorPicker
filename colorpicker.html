<html><head><title>Canvas捡色器</title></head>
<script src=./js/drag.js></script>

<body><div id="ImageEditor"  contenteditable="true" style="position: absolute;left: 300px;top: 126px;width: 400px;height: 450px;z-index: 999;background-color: rgb(204, 204, 204);visibility: visible;">
  <div id="CP">
    <div onmousedown="drag(this,event,0)" style="background-color:#0a0a0a">
      <div style="position:absolute;left:0px;top:5px;width: 371px;color:white;" align="center">图片编辑</div>
      <div align="right" ><img style="position: relative;height:24px;width:24px;right: 5px; top: 5px;" src="./img/close.png" onclick="hideQuiz();"><hr></div>
    </div>
    <div style="width: 386px;height: 400px;margin: 0px 7px auto;text-align: center;">
       <div align="center" id=preview style="min-height:100px;max-height:200px">请将图片粘贴到此处</div><hr>
      <div align="center">
        <div><label><input type=checkbox name=T id=T onclick="setColorPicker();">设置透明色</label></div><hr>
        <div id="colorpicker"  style="display:none">
           <div>
              X:<input type=text name=X id=X style="width:60px;">
              Y:<input type=text name=Y id=Y style="width:60px;">
           </div><hr>
           <!--div><input type=button value=重设 onclick="resetStatus();"><hr-->
           <div style="height:40px">
              <input type=button id=color  style="position: relative;left: 0px;top:0px;width:40px;height:40px;background:white;border:black;">
           </div><hr>
           <div>
              R<input type=text id=b1 style="width:40px;">
              G<input type=text id=b2 style="width:40px;">
              B<input type=text id=b3 style="width:40px;">
              A<input type=text id=b4 style="width:40px;">
           </div><hr>
           <div>
              <input type=text id=c2>
           </div><hr>
           <div>
              <input type=button onclick="resetColor();" value="重选颜色">
           </div><hr>
        </div>
        <div><input type=submit></div>
      </div>
    </div>
  </div>
</div>

<script>

var ctx;
var canvas;
var img;

//白板图片资源上传
window.onload = function () 
{
   function pasteImg(e) 
   {
      if (e.clipboardData.items) 
      {
         var ele = e.clipboardData.items
         for (var i = 0; i < ele.length; ++i) 
         {
            if (ele[i].kind == 'file' && ele[i].type.indexOf('image/') !== -1) 
            {
               var blob = ele[i].getAsFile();
               window.URL = window.URL || window.webkitURL;
               var blobUrl = window.URL.createObjectURL(blob);

               var new_img = document.createElement('img');
               convertImgToBase64(blobUrl, function(base64Img)
               {
                  new_img.setAttribute('src', base64Img);
                  new_img.onmousemove=function(){showPos(this,event);};
                  new_img.onmouseout=function(){resetPos(this);};
                  //new_img.onmousedown=function(){setStatus();};
                  new_img.onmousedown=function(){setColor();};
                  var p=document.getElementById('preview');
                  p.innerHTML="";
//                  if(p.children.length>0)
  //                {
    //                 for(var n=p.children.length-1;n>=0;n--)
      //                  p.removeChild(p.children[n]);
        //          }
                  document.getElementById('preview').appendChild(new_img);
               });
            }
         }
      } 
      else 
      {
         alert('您的浏览器不支持粘贴图片功能,请换更高版本浏览器.');
      }
   }
   document.getElementById('ImageEditor').onpaste = function () {
      pasteImg(event);
      return false;
   };
}

//CanvasRenderingContext2D

function convertImgToBase64(url, callback, outputFormat){
   canvas = document.createElement('CANVAS'),
   ctx = canvas.getContext('2d',{willReadFrequently:true}),
   img = new Image;
   img.crossOrigin = 'Anonymous';
   img.onload = function(){
      canvas.height = img.height;
      canvas.width = img.width;
      ctx.drawImage(img,0,0);
      var dataURL = canvas.toDataURL(outputFormat || 'image/png');
      callback.call(this, dataURL);
      canvas = null;
   };
   img.src = url;
}
//白板图片资源上传
</script>
<script>

var bColorPicker=false;		//捡色功能未开启
var bColorSet=false;		//所捡颜色未确定

//当鼠标在图片上移动时，显示当前鼠标在图片内的坐标
function showPos(o,ev)
{
   if(bColorPicker && !bColorSet)	//开启捡色功能，且所捡颜色未设定
   {
      var x=document.getElementById("X");
      var y=document.getElementById("Y");
      x.value=ev.clientX-o.offsetLeft-parseInt(o.parentElement.parentElement.parentElement.parentElement.style.left);
      y.value=ev.clientY-o.offsetTop-parseInt(o.parentElement.parentElement.parentElement.parentElement.style.top);	//计算鼠标相对于图片的坐标
      setStatus(x.value,y.value);	//获取鼠标所在点的像素值，并更新界面
   }
}

//鼠标移除图片位置，则重置坐标：归零
function resetPos(o)
{
   if(bColorPicker && !bColorSet)	//开启捡色功能，且所捡颜色未设定
   {
      document.getElementById("X").value=0;
      document.getElementById("Y").value=0;	//重置，归零
   }
}

//鼠标单击图片，完成捡色确定
function setColor()
{
   if(bColorPicker && !bColorSet)	//开启捡色功能，且所捡颜色未设定
   {
      bColorSet=true;
   }
}

//重新开始捡色
function resetColor()
{
   bColorSet=false;
}

//获取图片内鼠标所在坐标的点的颜色值，并更新界面
function setStatus(x,y)
{
   var start_x=parseInt(x);
   var start_y=parseInt(y);
   if(start_x>0 && start_y>0)						//鼠标在图片上移动时的坐标，从(1,1)开始，而图像数据从(0,0)开始
   {
      var data=ctx.getImageData(start_x-1,start_y-1,1,1);		//获取当前点。
      if(data.colorSpace=="srgb" && data.data.length==4)		//sRGB
      {
         var c=document.getElementById("color");
         c.style.background="rgb("+data.data[0]+","+data.data[1]+","+data.data[2]+")";
         var c2=document.getElementById("c2");
         c2.value= "rgb("+data.data[0]+","+data.data[1]+","+data.data[2]+")";
         for(var i=0;i<4;i++)
         {
            var b=document.getElementById("b"+(i+1));
            b.value=data.data[i].toString(16).toUpperCase();
         }
      }
   }
}

//切换捡色开启/关闭状态
function setColorPicker()
{
   if(bColorPicker) document.getElementById("colorpicker").style.display="none";
   else document.getElementById("colorpicker").style.display="block";
   bColorPicker=!bColorPicker;
}

</script>
</body></html>
